---
import { REALISATIONS } from '~/config.mjs';

import Layout from '~/layouts/PageLayout.astro';
import SingleRealisation from '~/components/realisations/SingleRealisation.astro';
import ToBlogLink from '~/components/realisations/ToBlogLink.astro';
import RealisationPage from '../../../tina/pages/RealisationPage';

import { getCanonical, getPermalink } from '~/utils/permalinks';
import { fetchRealisations } from '~/utils/realisations';
import { findImage } from '~/utils/images';
import type { Realisation } from '~/types';
import client from '../../../tina/__generated__/client';

type TinaRealisationsQuery = Awaited<ReturnType<typeof client.queries.realisations>>;

export async function getStaticPaths() {
  if (REALISATIONS?.disabled || REALISATIONS?.post?.disabled) return [];
  return (await fetchRealisations()).map((post) => {
    const relativePath = post.id.endsWith('.md') ? post.id : `${post.id}.md`;
    return {
      params: {
        realisations: post.permalink,
      },
      props: {
        post,
        relativePath,
        getTinaProps: async () => client.queries.realisations({ relativePath }),
      },
    };
  });
}

export interface Props {
  post: Realisation;
  relativePath: string;
  getTinaProps?: () => Promise<TinaRealisationsQuery>;
}

const { post, getTinaProps, relativePath } = Astro.props;
const url = getCanonical(getPermalink(post.permalink, 'realisations'));

const meta = {
  title: post.title,
  description: post.accroche,
  url: url,
  image: await findImage(post.image),
  noindex: REALISATIONS?.post?.noindex,
  ogType: 'article',
};

// Load data from TinaCMS for visual editing
let tinaData = null;
try {
  tinaData = getTinaProps ? await getTinaProps() : await client.queries.realisations({ relativePath });
} catch (error) {
  console.warn(`Could not load TinaCMS data for ${relativePath}:`, error);
}
---

<style>
  .tina-visual-only {
    display: none;
  }

  body[data-tina-visual='true'] .tina-visual-only {
    display: block;
  }

  body[data-tina-visual='true'] .tina-site-view {
    display: none;
  }
</style>

<Layout {meta}>
  <div class="tina-site-view">
    <SingleRealisation post={{ ...post, image: meta.image }} url={url} />
  </div>

  {tinaData && (
    <div class="tina-visual-only" aria-hidden="true">
      <RealisationPage
        data={tinaData.data}
        query={tinaData.query}
        variables={{ relativePath }}
        url={String(url)}
        client:tina
      />
    </div>
  )}
  <ToBlogLink />
</Layout>
